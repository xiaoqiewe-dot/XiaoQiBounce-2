name: 构建并发布发行版

on:
  push:
    branches: [ nextgen ]
  workflow_dispatch:

jobs:
  build-and-release:
    if: github.ref == 'refs/heads/nextgen'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 检出仓库和子模块
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 配置 JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'graalvm'
          java-version: '21'

      - name: 授予 src-theme 权限
        run: sudo chmod -R 777 src-theme

      - name: 构建项目
        uses: gradle/gradle-build-action@v3
        env:
          CI: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          arguments: genSources build -x test -x detekt

      - name: 准备发行版元数据
        id: metadata
        run: |
          BUILD_TIME=$(date -u +"%Y年%m月%d日-%H时%M分%S秒")
          BUILD_TIME_TAG=$(date -u +"%Y%m%d-%H%M%S")
          echo "build_time=$BUILD_TIME" >> "$GITHUB_OUTPUT"
          echo "tag_name=$BUILD_TIME_TAG" >> "$GITHUB_OUTPUT"
          echo "release_name=$BUILD_TIME" >> "$GITHUB_OUTPUT"
          echo "release_body=自动构建版本 - 提交: $GITHUB_SHA - 构建时间: $BUILD_TIME (UTC)" >> "$GITHUB_OUTPUT"

      - name: 定位构建产物
        id: artifact
        run: |
          JAR_PATH=$(find build/libs -maxdepth 1 -type f -name '*.jar' ! -name '*-sources.jar' ! -name '*-javadoc.jar' | head -n 1)
          if [ -z "$JAR_PATH" ]; then
            echo "Unable to locate jar artifact in build/libs"
            exit 1
          fi
          ASSET_NAME=$(basename "$JAR_PATH")
          echo "jar_path=$JAR_PATH" >> "$GITHUB_OUTPUT"
          echo "asset_name=$ASSET_NAME" >> "$GITHUB_OUTPUT"

      - name: 创建 GitHub 发行版
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.metadata.outputs.tag_name }}
          name: ${{ steps.metadata.outputs.release_name }}
          body: ${{ steps.metadata.outputs.release_body }}
          draft: false
          prerelease: false
          files: ${{ steps.artifact.outputs.jar_path }}
