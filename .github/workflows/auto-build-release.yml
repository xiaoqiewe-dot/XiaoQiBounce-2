name: 自动构建JAR并发布发行版

on:
  push:
    branches: [ ci-gh-actions-build-jar-release-timestamp ]
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 检出仓库和子模块
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 设置JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'graalvm'
          java-version: '21'

      - name: 授予src-theme权限
        run: sudo chmod -R 777 src-theme

      - name: 缓存Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: 设置和构建
        uses: gradle/gradle-build-action@v3
        env:
          CI: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          arguments: genSources build -x test -x detekt

      - name: 准备发行版元数据
        id: metadata
        run: |
          BUILD_TIME=$(date -u +"%Y%m%d-%H%M%S")
          echo "build_time=$BUILD_TIME" >> "$GITHUB_OUTPUT"
          echo "tag_name=$BUILD_TIME" >> "$GITHUB_OUTPUT"
          echo "release_name=构建版本 $BUILD_TIME" >> "$GITHUB_OUTPUT"
          echo "release_body=自动构建版本，基于提交 ${{ github.sha }}，构建时间：$BUILD_TIME UTC" >> "$GITHUB_OUTPUT"

      - name: 定位构建产物
        id: artifact
        run: |
          JAR_PATH=$(find build/libs -maxdepth 1 -type f -name '*.jar' ! -name '*-sources.jar' ! -name '*-javadoc.jar' | head -n 1)
          if [ -z "$JAR_PATH" ]; then
            echo "未找到JAR文件"
            exit 1
          fi
          ASSET_NAME="XiaoQiBounce-${{ steps.metadata.outputs.build_time }}.jar"
          echo "jar_path=$JAR_PATH" >> "$GITHUB_OUTPUT"
          echo "asset_name=$ASSET_NAME" >> "$GITHUB_OUTPUT"
          
          echo "找到JAR文件: $JAR_PATH"
          echo "文件大小: $(stat -c%s "$JAR_PATH") 字节"
          
          # 复制JAR文件并重命名
          cp "$JAR_PATH" "./$ASSET_NAME"
          echo "renamed_jar_path=./$ASSET_NAME" >> "$GITHUB_OUTPUT"

      - name: 创建GitHub发行版
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.metadata.outputs.tag_name }}
          name: ${{ steps.metadata.outputs.release_name }}
          body: ${{ steps.metadata.outputs.release_body }}
          draft: false
          prerelease: false
          files: |
            ${{ steps.artifact.outputs.renamed_jar_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 上传构建产物到GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: XiaoQiBounce-${{ steps.metadata.outputs.build_time }}
          path: ${{ steps.artifact.outputs.renamed_jar_path }}
          retention-days: 30